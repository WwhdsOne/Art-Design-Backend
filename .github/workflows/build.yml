name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: art-design-backend
      CONTAINER_NAME: art-design-backend
      CONSUL_ADDR: my-consul:8500
      CONSUL_CONFIG_KEY: ${{ secrets.CONSUL_CONFIG_KEY }}
      OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SSH_USER:  ${{ secrets.SSH_USER }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
    steps:
      # ç”¨äºæ‹‰å–ä»£ç 
      - name: Check out repository code
        uses: actions/checkout@v4
      # è®¾ç½®GOè¯­è¨€ç¯å¢ƒ
      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          # è‡ªå»ºRunneréœ€è¦å…³é—­ç¼“å­˜ï¼Œå¦åœ¨ä¼šæŠ¥é”™
          # åœ¨issue https://github.com/actions/setup-go/issues/403 æåŠ
          cache: true

      - name: Install UPX
        if: steps.cache-upx.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/upx/upx/releases/download/v5.0.1/upx-5.0.1-amd64_linux.tar.xz -o upx.tar.xz
          tar -xf upx.tar.xz
          mkdir -p ~/upx
          mv upx-*/upx ~/upx

      - name: Add UPX to PATH
        run: echo "$HOME/upx" >> $GITHUB_PATH

      - name: Update Go dependencies
        run: |
          # æ›´æ–°ä¾èµ–
          go get -u ./... && go mod tidy

      - name: Build Application
        run: |
          sh scripts/build.sh
      - name: Cleanup existing Docker container and image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” Checking and cleaning existing Docker container and image..."
            
            # å¼ºåˆ¶åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker ps -a --filter "name=${{ env.CONTAINER_NAME }}" --format "{{.Names}}" | grep -q "${{ env.CONTAINER_NAME }}"; then
                echo "ğŸ›‘ Force stopping and removing container: ${{ env.CONTAINER_NAME }}"
                docker stop ${{ env.CONTAINER_NAME }} --time 0 || true  # ç«‹å³å¼ºåˆ¶åœæ­¢
                docker rm -f ${{ env.CONTAINER_NAME }} || true          # å¼ºåˆ¶åˆ é™¤å®¹å™¨
                echo "âœ… Container ${{ env.CONTAINER_NAME }} removed."
            else
                echo "â„¹ï¸ No container named ${{ env.CONTAINER_NAME }} found."
            fi
            
            # å¼ºåˆ¶åˆ é™¤æ—§é•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "${{ env.IMAGE_NAME }}:latest"; then
                echo "ğŸ§¹ Force removing image: ${{ env.IMAGE_NAME }}:latest"
                docker rmi -f ${{ env.IMAGE_NAME }}:latest || true
                echo "âœ… Image ${{ env.IMAGE_NAME }}:latest removed."
            else
                echo "â„¹ï¸ No image named ${{ env.IMAGE_NAME }}:latest found."
            fi
      - name: Upload artifact to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "myapp,Dockerfile"
          target: "/home/docker-images/${{ env.IMAGE_NAME }}"

      - name: Build Docker image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/docker-images/${{ env.IMAGE_NAME }}

            # ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒï¼Œå¹¶æŒ‡å®šé•œåƒåç§°ä¸º${{ env.IMAGE_NAME }}
            docker build -t ${{ env.IMAGE_NAME }}:latest .
            
             # å¯åŠ¨æ–°é•œåƒçš„å®¹å™¨ï¼ŒæŒ‡å®šå®¹å™¨åç§°ä¸º${{ env.CONTAINER_NAME }}
            docker run -d \
            --network docker-compose_app-net \
            --name ${{ env.CONTAINER_NAME }} \
            --restart always \
            -e CONSUL_ADDR=${{ env.CONSUL_ADDR }} \
            -e CONSUL_CONFIG_KEY=${{ env.CONSUL_CONFIG_KEY }} \
            -e OSS_ACCESS_KEY_ID=${{ env.OSS_ACCESS_KEY_ID }} \
            -e OSS_ACCESS_KEY_SECRET=${{ env.OSS_ACCESS_KEY_SECRET }} \
            ${{ env.IMAGE_NAME }}:latest

         
            
            
